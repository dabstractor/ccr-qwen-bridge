# Qwen-Code OAuth 2.0 Device Flow: Implementation Details

This report contains the specific technical details required to re-implement the Qwen-Code authentication lifecycle.

## 1. PKCE (Proof Key for Code Exchange) Implementation

*   **`code_verifier` Generation:**
    *   **Description:** The `code_verifier` is generated by creating 32 random bytes using Node.js's `crypto.randomBytes(32)` function. This raw buffer is then encoded into a string using `base64url` format.
    *   **Source:** `packages/core/src/qwen/qwenOAuth2.ts:45`

*   **`code_challenge` Generation:**
    *   **Description:** The `code_challenge` is generated by taking the `code_verifier` string, creating a SHA-256 hash of it, and then encoding the resulting hash digest into a `base64url` string.
    *   **`code_challenge_method`:** The value of the `code_challenge_method` parameter is hardcoded to `'S256'`.
    *   **Source:** `packages/core/src/qwen/qwenOAuth2.ts:52` and `packages/core/src/qwen/qwenOAuth2.ts:552`

## 2. Device Flow Polling Mechanics

*   **Polling Interval:**
    *   **Description:** The polling interval is not derived from the device authorization response. It starts with a hardcoded value of 2000 milliseconds (2 seconds). If the token server responds with a `slow_down` error, the interval is increased by 50% for the next attempt, up to a maximum of 10 seconds. If the server does not request to slow down, the interval resets to the default 2 seconds.
    *   **Source:** `packages/core/src/qwen/qwenOAuth2.ts:609` and `packages/core/src/qwen/qwenOAuth2.ts:666-672`

*   **Polling Loop Logic:**
    *   **Description:** The client polls the token endpoint in a loop. The loop continues as long as the server returns an `authorization_pending` error. The loop terminates under the following conditions:
        1.  **Success:** The server returns a valid `access_token`.
        2.  **User Cancellation:** The user explicitly cancels the flow.
        3.  **Timeout:** The total polling time exceeds the `expires_in` value received from the initial device authorization request.
        4.  **Error:** The server returns an unrecoverable error such as `access_denied`, `expired_token`, or the client's `device_code` is invalid.
    *   **Source:** `packages/core/src/qwen/qwenOAuth2.ts:336-340` (pending logic) and `packages/core/src/qwen/qwenOAuth2.ts:612-720` (polling loop).

## 3. Dynamic API Endpoint Construction

*   **`resource_url` Processing:**
    *   **Description:** The final API base URL is determined dynamically. The client first checks for a `resource_url` field in the token response. If present, this URL is used as the base endpoint. If it is not present, a hardcoded fallback URL (`https://dashscope.aliyuncs.com/compatible-mode/v1`) is used. The logic then ensures this base URL has a protocol (prepending `https://` if missing) and that it ends with a `/v1` path segment (appending it if missing).
    *   **Example `resource_url`:** No concrete examples were found in the source code or tests. However, based on the fallback, a likely format is `https://some-endpoint.aliyuncs.com/compatible-mode`.
    *   **Source:** `packages/core/src/qwen/qwenContentGenerator.ts:23-25` (fallback) and `packages/core/src/qwen/qwenContentGenerator.ts:50-61` (construction logic).

## 4. Token Expiration and Storage Format

*   **`expiry_date` Format:**
    *   **Description:** The `expiry_date` is calculated and stored as a Unix timestamp in **milliseconds**. The logic takes the current time via `Date.now()` and adds the `expires_in` value (which is in seconds) after converting it to milliseconds by multiplying by 1000.
    *   **Source:** `packages/core/src/qwen/qwenOAuth2.ts:424` and `packages/core/src/qwen/qwenOAuth2.ts:642-644`
